<!DOCTYPE html>
<html>

<head>
    <title>Video Call</title>
</head>

<body>
    <!-- HTML Structure -->
    <div id="videos">
        <video id="localVideo" autoplay playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>
    <div class="controls">
        <button id="muteAudio">Mute Audio</button>
        <button id="muteVideo">Mute Video</button>
        <button id="startCall">Start Call</button>
    </div>

    <!-- JavaScript -->
    <script>
        const connectedClients = new Set();
        let localStream;
        let peerConnection;
        const clientId = 'user-' + Math.random().toString(36).substr(2, 9);
        const ws = new WebSocket(`wss://${window.location.host}/ws?id=${clientId}`);

        async function createPeerConnection() {
            const configuration = {
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            };

            peerConnection = new RTCPeerConnection(configuration);

            // Add local tracks to connection
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Handle incoming remote stream
            peerConnection.ontrack = event => {
                console.log('Received remote track');
                document.getElementById('remoteVideo').srcObject = event.streams[0];
            };

            // Send ICE candidates to peer
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    console.log('Sending ICE candidate');
                    ws.send(JSON.stringify({
                        type: 'candidate',
                        data: JSON.stringify(event.candidate),
                        to: Array.from(connectedClients)[0] // Send to first connected peer
                    }));
                }
            };

            return peerConnection;
        }

        async function initWebRTC() {
            try {
                if (!navigator.mediaDevices) {
                    throw new Error('mediaDevices API not supported');
                }

                // Check if running on HTTPS or localhost
                if (!window.location.protocol.startsWith('https') &&
                    window.location.hostname !== 'localhost') {
                    throw new Error('WebRTC requires HTTPS (or localhost)');
                }

                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: true
                });
                document.getElementById('localVideo').srcObject = localStream;
                await createPeerConnection();
            } catch (e) {
                console.error('Error initializing WebRTC:', e);
                alert('Unable to access camera/microphone. Please ensure you are using HTTPS and have granted permissions.');
            }
        }

        document.getElementById('startCall').onclick = async () => {
            try {
                console.log('Starting call...');
                const availablePeers = Array.from(connectedClients);
                if (availablePeers.length === 0) {
                    console.log('No other users connected');
                    return;
                }

                const targetPeer = availablePeers[0];
                console.log('Creating offer for peer:', targetPeer);

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                ws.send(JSON.stringify({
                    type: 'offer',
                    data: JSON.stringify(offer),
                    to: targetPeer
                }));
            } catch (e) {
                console.error('Error starting call:', e);
            }
        };

        ws.onmessage = async function (event) {
            const message = JSON.parse(event.data);
            console.log('Received message:', message);

            try {
                switch (message.type) {
                    case 'new_user':
                        if (message.data !== clientId) {
                            connectedClients.add(message.data);
                            console.log('New user joined:', message.data);
                        }
                        break;

                    case 'offer':
                        console.log('Received offer');
                        await peerConnection.setRemoteDescription(JSON.parse(message.data));
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        ws.send(JSON.stringify({
                            type: 'answer',
                            data: JSON.stringify(answer),
                            to: message.from
                        }));
                        break;

                    case 'answer':
                        console.log('Received answer');
                        await peerConnection.setRemoteDescription(JSON.parse(message.data));
                        break;

                    case 'candidate':
                        console.log('Received ICE candidate');
                        if (message.data) {
                            const candidate = JSON.parse(message.data);
                            await peerConnection.addIceCandidate(candidate);
                        }
                        break;
                }
            } catch (e) {
                console.error('Error handling message:', e);
            }
        };

        // Initialize when page loads
        initWebRTC().catch(console.error);
    </script>

    <!-- CSS Styles -->
    <style>
        #videos {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        video {
            width: 100%;
            max-width: 600px;
            border-radius: 8px;
            background: #2c2c2c;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px;
        }

        button {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            background: #007bff;
            color: white;
            cursor: pointer;
        }

        button.muted {
            background: #dc3545;
        }
    </style>
</body>

</html>